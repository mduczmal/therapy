<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" crossorigin="anonymous" />
    <title>Ogłoszenie</title>
</head>
<body>
<nav class="navbar navbar-dark bg-success">
    <a class="navbar-brand">Terapia</a>
    <a th:href="@{/create}" class="btn btn-success btn-outline-light ml-auto">Dodaj ogłoszenie</a>
    <a th:unless="${therapist == null && moderator == null}" th:href="@{/logout}" class="btn btn-success btn-outline-dark ml-3">Wyloguj</a>
    <a th:if="${therapist == null && moderator == null}" th:href="@{/login}" class="btn btn-success btn-outline-dark ml-3">Zaloguj</a>
</nav>
<div class="card w-50 mt-3 mb-4 mx-auto">
    <div class="card-header">
        <ul class="nav nav-pills card-header-pills">
            <li class="nav-item">
                <a th:href="@{/}" class="btn btn-success">Wróć do listy ogłoszeń</a>
            </li>
            <li th:if="${moderator != null || (therapist != null && therapist.ad == ad.id)}"
                class="nav-item ml-auto">
                <form th:action="@{/remove/{id}(id=${ad.id})}" method="post">
                    <button type="submit" class="btn btn-secondary ml-auto">Usuń</button>
                </form>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <h3 class="card-title" th:text="${ad.details.name + ' ' + ad.details.surname}">Name and surname</h3>
        <h5 class="card-subtitle mb-4 text-muted">
            <span th:text="${ad.details.address}">Address</span>
        </h5>
        <div th:if="${ad.details.telephoneNumber != null}" class="d-flex mx-auto mb-3 py-1">
            <div class="rounded-left text-light bg-success px-4 py-3">
                Telefon
            </div>
            <div class="rounded-right bg-light border-secondary flex-grow-1 px-4 py-3"
                 th:text="${ad.details.telephoneNumber}">
                Numer telefonu
            </div>
        </div>
        <div th:if="${ad.details.email != null}" class="d-flex mx-auto mb-3 py-1">
            <div class="rounded-left text-light bg-success px-4 py-3">
                Email
            </div>
            <div class="rounded-right bg-light border-secondary flex-grow-1 px-4 py-3"
                 th:text="${ad.details.email}">
                Adres email
            </div>
        </div>
        <div class="mx-auto w-100 rounded-top text-light bg-success px-4 py-3">
            Sczegółowe informacje o psychoterapii
        </div>
        <div th:if="${ad.details.description == null}" class="mx-auto w-100 rounded-bottom bg-light mb-3 px-4 py-3">
            Terapeuta nie podał opisu terapii.
        </div>
        <div th:if="${ad.details.description != null}"
             th:text="${ad.details.description}"
             class="mx-auto w-100 rounded-bottom bg-light mb-3 px-4 py-3">
            Opis psychoterapii
        </div>
    </div>
</div>
<div class="card w-50 mx-auto mt-3 mb-4">
    <div class="card-header px-2 py-1">
        <div class="row px-4">
            <h4 class="my-auto">Komentarze</h4>
            <button id="newCommentButton" type="submit" class="btn btn-secondary ml-auto"
                    data-toggle="collapse" data-target="#newComment">Dodaj opinię</button>
        </div>
    </div>
    <div class="card-body">
        <div class="card" th:each="comment, iter: ${ad.comments}">
            <div class="card-body">
                <form class="d-flex"
                      th:action="@{/delcomment/{ad_id}/{comment_id}(ad_id=${id}, comment_id=${iter.index})}"
                      method="post">
                    <h6 class="card-title" th:text="${comment.author}">Autor komentarza</h6>
                    <button th:if="${moderator != null}" type="submit"
                            class="btn btn-secondary ml-auto">Usuń</button>
                </form>
                <div class="card-text" th:text="${comment.content}">Treść komentarza</div>
            </div>
        </div>
    </div>
    <div id="newComment" class="card card-footer collapse">
        <div class="card-body">
            <h6 class="card-title">Nowy komentarz</h6>
            <form id="newCommentForm" th:object="${new_comment}">
                <div class="form-group">
                    <label for="author" class="px-2 pt-2">Pseudonim</label>
                    <input type="text" class="form-control" th:field="*{author}" id="author" placeholder="Twoje imię">
                </div>
                <div class="form-group">
                    <label for="commentContent" class="px-2 pt-2">Treść komentarza</label>
                    <textarea class="form-control" id="commentContent" rows="2" placeholder="Twoja opinia"></textarea>
                </div>
                <button type="submit" class="btn btn-secondary ml-auto">Zapisz komentarz</button>
            </form>
        </div>
    </div>
</div>
<script th:src="@{/js/jquery-3.5.1.min.js}" crossorigin="anonymous"></script>
<script>
    function getCookie(n) {
        //https://stackoverflow.com/questions/5639346/what-is-the-shortest-function-for-reading-a-cookie-by-name-in-javascript
        let c = document.cookie.match('(^|;)\\s*' + n + '\\s*=\\s*([^;]+)');
        return c ? c.pop() : '';
    }
    $('#newComment').on('shown.bs.collapse', function () {
        $("html, body").animate({ scrollTop: $("#newComment").offset().top }, 1000);
    });
    $('#newCommentForm').on('submit', function(event) {
        event.preventDefault();
        let headers = new Headers();
        headers.set('Accept', 'application/json');
        headers.set('Content-Type', 'application/json');
        let token = getCookie("XSRF-TOKEN");
        headers.set("X-XSRF-TOKEN", token);
        fetch("/comment", {
            method: "POST",
            headers
        }).then(response => response.json())
        .then(function(data) {
            console.log(data);
            alert(data.response);
        });
    })
</script>
<script th:src="@{/js/bootstrap.bundle.min.js}" crossorigin="anonymous"></script>
</body>
</html>